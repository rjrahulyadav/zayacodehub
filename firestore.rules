/**
 * This ruleset enforces a strict role-based access control model for a public-facing
 * portfolio and hiring website. The core philosophy is to make content publicly
 * readable while restricting all write operations (create, update, delete) to a
 * designated administrator.
 *
 * Core Philosophy:
 * - Public Read-Only: All projects and hiring posts are visible to everyone,
 *   including anonymous visitors, to maximize content reach.
 * - Admin-Only Writes: All content creation, modification, and deletion is strictly
 *   limited to users with administrative privileges.
 *
 * Data Structure:
 * - /projects/{projectId}: A top-level collection for publicly visible portfolio projects.
 * - /hiring_posts/{hiringPostId}: A top-level collection for publicly visible job openings.
 * - /roles_admin/{adminId}: A private, locked-down collection where the existence
 *   of a user's UID as a document ID grants them admin rights.
 *
 * Key Security Decisions:
 * - Role-Based Access Control (RBAC): Admin status is determined by checking for the
 *   existence of a document in the `/roles_admin` collection. This requires a `get()`
 *   call but is a standard and secure pattern for managing roles.
 * - Hardcoded Admin Email: For an additional layer of security, the admin check also
 *   verifies that the authenticated user's email is 'zayacodehub@gmail.com'.
 * - Locked Admin Collection: The `/roles_admin` collection is not writable by any
 *   client. Admin roles must be assigned manually through the Firebase Console or a
 *   trusted server-side process to prevent privilege escalation.
 * - Default Deny: Access is denied by default, and permissions are granted explicitly.
 *
 * Denormalization for Authorization:
 * - This ruleset uses a role-based system rather than per-document ownership.
 *   The central `isAdmin()` function checks a dedicated `/roles_admin` collection,
 *   which is an efficient and standard pattern for global roles. No per-document
 *   denormalization is required for this model.
 *
 * Structural Segregation:
 * - Public content (`projects`, `hiring_posts`) is structurally separated from
 *   sensitive authorization data (`roles_admin`). This clear separation simplifies
 *   rules and prevents accidental data exposure.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------//
    // Helper Functions
    //-------------------------------------------------------------------------//

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user has administrative privileges.
     * An admin must be signed in, have their email verified as the specific
     * admin email, and have a corresponding document in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn()
        && request.auth.token.email == 'zayacodehub@gmail.com'
        && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }


    //-------------------------------------------------------------------------//
    // Collection Rules
    //-------------------------------------------------------------------------//

    /**
     * @description Controls access to portfolio projects. Allows public read access for all
     *              visitors but restricts all write operations to administrators.
     * @path /projects/{projectId}
     * @allow (get) Any user, signed-in or anonymous, can read a specific project.
     * @allow (create) An authenticated admin user can create a new project document.
     * @deny (update) A non-admin user cannot modify an existing project.
     * @principle Public read with role-based writes. Secures content management by
     *            ensuring only authorized personnel can alter public-facing data.
     */
    match /projects/{projectId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages access to job openings. Hiring posts are public to read,
     *              ensuring wide visibility, but can only be managed by administrators.
     * @path /hiring_posts/{hiringPostId}
     * @allow (list) Any user, signed-in or anonymous, can list all hiring posts.
     * @allow (delete) An authenticated admin user can delete an existing hiring post.
     * @deny (create) An anonymous user cannot create a new hiring post.
     * @principle Public read with role-based writes. Protects the integrity of job
     *            postings by restricting content management to verified admins.
     */
    match /hiring_posts/{hiringPostId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description A locked-down collection that defines admin roles. The existence
     *              of a document with a user's UID as the ID grants them admin status.
     *              This collection MUST NOT be readable or writable from the client.
     * @path /roles_admin/{adminId}
     * @allow (get) No client-side reads are permitted to prevent user enumeration.
     * @allow (create) No client-side role creation is allowed to prevent privilege escalation.
     * @deny (list) A user cannot list all the admins on the platform.
     * @principle Locked-down collection for security-critical data. Roles must be
     *            managed via the Firebase Console or a secure backend process.
     */
    match /roles_admin/{adminId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}